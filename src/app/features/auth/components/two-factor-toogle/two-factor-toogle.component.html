<p-toast></p-toast>

<p-card>
  <div class="flex items-center justify-between">
    <div class="flex items-center space-x-4">
      <i
        [class]="
          is2FAEnabled
            ? 'pi pi-shield text-green-500 text-3xl'
            : 'pi pi-shield text-gray-400 text-3xl'
        "
      ></i>
      <div>
        <h3 class="text-lg font-semibold">Autenticación de Dos Factores</h3>
        <p class="text-sm text-gray-600">
          {{
            is2FAEnabled
              ? "Tu cuenta está protegida con 2FA"
              : "Aumenta la seguridad de tu cuenta"
          }}
        </p>
        <p
          *ngIf="is2FAEnabled && backupCodesRemaining !== null"
          class="text-xs text-gray-500 mt-1"
        >
          {{ backupCodesRemaining }} códigos de respaldo disponibles
        </p>
      </div>
    </div>

    <p-button
      [label]="is2FAEnabled ? 'Desactivar 2FA' : 'Activar 2FA'"
      [severity]="is2FAEnabled ? 'danger' : 'success'"
      [icon]="is2FAEnabled ? 'pi pi-times' : 'pi pi-shield'"
      [outlined]="true"
      (onClick)="is2FAEnabled ? openDisableDialog() : openEnableDialog()"
      [loading]="loading"
    ></p-button>
  </div>
</p-card>

<!-- Dialog ACTIVAR 2FA -->
<p-dialog
  header="Activar Autenticación de Dos Factores"
  [(visible)]="showEnableDialog"
  [modal]="true"
  [style]="{ width: '550px' }"
  [closable]="!loading"
  [closeOnEscape]="!loading"
>
  <div class="space-y-6">
    <!-- Paso 1: Escanear QR -->
    <div *ngIf="currentStep === 'qr' && setupData">
      <h3 class="font-semibold mb-3 text-lg">Paso 1: Escanea el código QR</h3>
      <p class="text-sm text-gray-600 mb-4">
        Abre <strong>Google Authenticator</strong>,
        <strong>Microsoft Authenticator</strong> o cualquier app compatible
      </p>

      <div class="flex justify-center mb-4 bg-white p-4 rounded">
        <img [src]="setupData.qrCodeImage" alt="QR Code" class="w-64 h-64" />
      </div>

      <p-divider>O ingresa manualmente esta clave</p-divider>

      <div
        class="bg-gray-100 p-3 rounded text-center font-mono text-sm break-all select-all text-amber-600"
      >
        {{ setupData.manualEntryKey }}
      </div>

      <p-button
        label="Siguiente: Verificar Código"
        icon="pi pi-arrow-right"
        iconPos="right"
        styleClass="w-full mt-4"
        (onClick)="currentStep = 'verify'"
      ></p-button>
    </div>

    <!-- Paso 2: Verificar código -->
    <div *ngIf="currentStep === 'verify'">
      <h3 class="font-semibold mb-3 text-lg">Paso 2: Verifica el código</h3>
      <p class="text-sm text-gray-600 mb-4">
        Ingresa el código de <strong>6 dígitos</strong> que aparece en tu
        aplicación autenticadora
      </p>

      <form [formGroup]="verifyForm" (ngSubmit)="verifyAndActivate()">
        <input
          pInputText
          formControlName="code"
          placeholder="000000"
          class="w-full text-center text-3xl tracking-widest font-mono"
          maxlength="6"
          (input)="onCodeInput($event)"
          autofocus
        />

        <small class="block text-center text-xs text-gray-500 mt-2">
          El código cambia cada 30 segundos
        </small>

        <p-message
          *ngIf="setupError"
          severity="error"
          [text]="setupError"
          styleClass="w-full mt-4"
        ></p-message>

        <div class="flex gap-2 mt-4">
          <p-button
            type="button"
            label="Atrás"
            icon="pi pi-arrow-left"
            severity="secondary"
            [outlined]="true"
            styleClass="flex-1"
            (onClick)="currentStep = 'qr'"
            [disabled]="loading"
          ></p-button>
          <p-button
            type="submit"
            label="Verificar y Activar"
            icon="pi pi-check"
            styleClass="flex-1"
            [loading]="loading"
            [disabled]="verifyForm.invalid || loading"
          ></p-button>
        </div>
      </form>
    </div>

    <!-- Paso 3: Códigos de respaldo -->
    <div *ngIf="currentStep === 'backup' && setupData?.backupCodes">
      <div class="bg-red-50 border-2 border-red-200 rounded-lg p-4 mb-4">
        <div class="flex items-start space-x-3">
          <i class="pi pi-exclamation-triangle text-red-600 text-2xl"></i>
          <div>
            <h4 class="font-bold text-red-800 text-lg">¡IMPORTANTE!</h4>
            <p class="text-sm text-red-700 mt-1">
              Estos códigos solo se muestran <strong>una vez</strong>. Guárdalos
              en un lugar seguro.
            </p>
          </div>
        </div>
      </div>

      <h3 class="font-semibold mb-3 text-lg">Códigos de Respaldo</h3>
      <p class="text-sm text-gray-600 mb-3">
        Usa estos códigos si pierdes acceso a tu aplicación autenticadora
      </p>

      <div
        class="grid grid-cols-2 gap-2 bg-gray-50 p-4 rounded max-h-60 overflow-y-auto"
      >
        <div
          *ngFor="let code of setupData.backupCodes"
          class="font-mono text-sm bg-white p-3 rounded text-center border hover:bg-blue-50 cursor-pointer select-all"
        >
          {{ code }}
        </div>
      </div>

      <p-button
        label="He guardado los códigos - Finalizar"
        icon="pi pi-check-circle"
        styleClass="w-full mt-4"
        severity="success"
        (onClick)="finishSetup()"
      ></p-button>
    </div>
  </div>
</p-dialog>

<!-- Dialog DESACTIVAR 2FA -->
<p-dialog
  header="Deshabilitar Autenticación de Dos Factores"
  [(visible)]="showDisableDialog"
  [modal]="true"
  [style]="{ width: '450px' }"
>
  <div class="mb-4">
    <p class="text-gray-700 mb-2">
      Para deshabilitar 2FA, ingresa el código actual de tu aplicación
      autenticadora:
    </p>
  </div>

  <form [formGroup]="disableForm" (ngSubmit)="disableTwoFactor()">
    <input
      pInputText
      formControlName="code"
      placeholder="000000"
      class="w-full text-center text-2xl tracking-widest"
      maxlength="6"
      autofocus
    />

    <p-message
      *ngIf="disableError"
      severity="error"
      [text]="disableError"
      styleClass="w-full mt-3"
    ></p-message>

    <div class="flex gap-2 mt-4">
      <p-button
        type="button"
        label="Cancelar"
        severity="secondary"
        [outlined]="true"
        styleClass="flex-1"
        (onClick)="showDisableDialog = false"
        [disabled]="loading"
      ></p-button>
      <p-button
        type="submit"
        label="Deshabilitar"
        severity="danger"
        icon="pi pi-times"
        styleClass="flex-1"
        [loading]="loading"
        [disabled]="disableForm.invalid || loading"
      ></p-button>
    </div>
  </form>
</p-dialog>
